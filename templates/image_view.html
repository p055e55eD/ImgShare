{% extends "base.html" %}
{% block title %}{{ photo.title }} - ImgShare{% endblock %}

{% block navbar %}
<nav class="navbar">
    <div class="nav-container">
        <a href="/" class="logo">
            <i class="fas fa-camera"></i> ImgShare
            <span class="level-badge">Level {{ LEVEL }}</span>
        </a>
        <div class="nav-menu">
            <a href="/redirect?url={{ url_for('index') }}" class="nav-link">
                <i class="fas fa-th"></i> Gallery
            </a>
            {% if session.user %}
                <span class="nav-link">Welcome, {{ session.user }}!</span>
                <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            {% endif %}
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Image Navigation -->
    <div class="image-nav">
        <a href="/redirect?url={{ url_for('index') }}" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Back to Gallery
        </a>
        
        <div class="image-nav-info">
            <span>Image <strong>{{ photo.id }}</strong> of <strong id="totalCount">...</strong></span>
        </div>
        
        <div style="display: flex; gap: 0.5rem;" id="navButtons">
            <!-- Buttons will be added by JavaScript -->
        </div>
    </div>
    
    <!-- Main Image Container -->
    <div class="image-container">
        <img src="{{ photo.thumbnail }}" alt="{{ photo.title }}" class="full-image" id="mainImage"
             onerror="this.outerHTML='<div class=\\'broken-image\\'><i class=\\'fas fa-exclamation-triangle\\'></i><br><small>Image failed to load</small><br><code style=\\'font-size: 0.7rem; margin-top: 0.5rem; display: block;\\'>' + '{{ photo.url }}'.substring(0, 50) + '...</code></div>'">
        
        <div class="image-info">
            <h2>{{ photo.title }}</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
                <div>
                    <p><strong>Description:</strong></p>
                    <p style="margin-left: 1rem; font-style: italic; color: var(--text-secondary);">
                        {{ photo.description or 'No description provided' }}
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                    <div>
                        <p><strong>Uploaded by:</strong></p>
                        <p style="color: var(--text-secondary);">{{ photo.user }}</p>
                    </div>
                    <div>
                        <p><strong>Upload date:</strong></p>
                        <p style="color: var(--text-secondary);">{{ photo.uploaded }}</p>
                    </div>
                    <div>
                        <p><strong>Views:</strong></p>
                        <p style="color: var(--text-secondary);">{{ photo.views }}</p>
                    </div>
                    <div>
                        <p><strong>Image ID:</strong></p>
                        <p style="color: var(--text-secondary);">#{{ photo.id }}</p>
                    </div>
                </div>
            </div>
            
            <div style="margin: 1.5rem 0;">
                <p><strong>Original URL:</strong></p>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; align-items: center;">
                    <code style="flex: 1; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; font-size: 0.8rem; word-break: break-all; border: 1px solid var(--border);">{{ photo.url }}</code>
                    <button class="btn btn-icon btn-outline" onclick="copyToClipboard('{{ photo.url }}', 'Original URL copied!')" title="Copy original URL">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <!-- Share Section -->
            <div class="share-section">
                <h4><i class="fas fa-share-alt"></i> Share This Image</h4>
                
                <div class="share-buttons">
                    <button class="btn btn-secondary btn-sm" onclick="shareOnTwitter()" title="Share on Twitter">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="shareOnFacebook()" title="Share on Facebook">
                        <i class="fab fa-facebook"></i> Facebook
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="shareViaEmail()" title="Share via Email">
                        <i class="fas fa-envelope"></i> Email
                    </button>
                    <button class="btn btn-success btn-sm" onclick="copyImageLink()" title="Copy image link">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                </div>
                
                <div class="copy-link-container">
                    <input type="text" class="copy-link-input form-control" readonly
                           id="imageLink" value="{{ request.url }}"
                           onclick="this.select()">
                    <button class="btn btn-outline" onclick="copyImageLink()" title="Copy link">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Copy Feedback Modal -->
<div id="copyFeedback" class="copy-feedback">
    <i class="fas fa-check-circle"></i>
    <span id="copyFeedbackText">Link copied to clipboard!</span>
</div>

<script>
// Dynamic navigation setup
document.addEventListener('DOMContentLoaded', function() {
    const currentId = {{ photo.id }};
    
    // Try to determine total count by testing URLs
    let totalCount = 1;
    let testCount = 1;
    
    function testImageExists(id, callback) {
        fetch('/image/' + id, {method: 'HEAD'})
            .then(response => callback(response.ok))
            .catch(() => callback(false));
    }
    
    function findTotalCount(id) {
        testImageExists(id, function(exists) {
            if (exists) {
                totalCount = id;
                if (id < 20) { // Reasonable limit
                    findTotalCount(id + 1);
                } else {
                    setupNavigation();
                }
            } else {
                setupNavigation();
            }
        });
    }
    
    function setupNavigation() {
        // Update count display
        document.getElementById('totalCount').textContent = totalCount;
        
        const navButtons = document.getElementById('navButtons');
        navButtons.innerHTML = '';
        
        if (totalCount > 1) {
            // Add Previous button if not on first image
            if (currentId > 1) {
                navButtons.innerHTML += '<a href="/image/' + (currentId - 1) + '" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Previous</a>';
            }
            
            // Add Next button if not on last image
            if (currentId < totalCount) {
                navButtons.innerHTML += '<a href="/image/' + (currentId + 1) + '" class="btn btn-secondary">Next <i class="fas fa-arrow-right"></i></a>';
            }
        }
    }
    
    // Start testing from current ID upwards
    findTotalCount(Math.max(currentId, 1));
});

// Share functionality
function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('Check out this image: {{ photo.title }}');
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareViaEmail() {
    const subject = encodeURIComponent('Check out this image: {{ photo.title }}');
    const body = encodeURIComponent(`I found this interesting image on ImgShare:\n\n{{ photo.title }}\n{{ photo.description or "No description provided" }}\n\nView it here: ${window.location.href}`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

function copyImageLink() {
    copyToClipboard(window.location.href, 'Image link copied to clipboard!');
}

function copyToClipboard(text, message = 'Copied to clipboard!') {
    // Try modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback(message);
        }).catch(() => {
            // Fallback to older method
            fallbackCopyToClipboard(text, message);
        });
    } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopyToClipboard(text, message);
    }
}

function fallbackCopyToClipboard(text, message) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopyFeedback(message);
    } catch (err) {
        console.error('Failed to copy text: ', err);
        showCopyFeedback('Failed to copy to clipboard', true);
    }
    
    document.body.removeChild(textArea);
}

function showCopyFeedback(message, isError = false) {
    const feedback = document.getElementById('copyFeedback');
    const text = document.getElementById('copyFeedbackText');
    
    text.textContent = message;
    feedback.style.background = isError ? 'var(--error)' : 'var(--success)';
    feedback.classList.add('show');
    
    setTimeout(() => {
        feedback.classList.remove('show');
    }, 2000);
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    {% if next_photo %}
    if (e.key === 'ArrowRight' || e.key === ' ') {
        e.preventDefault();
        window.location.href = '/image/{{ next_photo.id }}';
    }
    {% endif %}
    
    {% if prev_photo %}
    if (e.key === 'ArrowLeft') {
        e.preventDefault();
        window.location.href = '/image/{{ prev_photo.id }}';
    }
    {% endif %}
    
    if (e.key === 'Escape') {
        e.preventDefault();
        window.location.href = '/redirect?url={{ url_for("index") }}';
    }
    
    // Copy link with Ctrl+C
    if (e.ctrlKey && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copyImageLink();
    }
});

// Image zoom functionality with improved controls
let zoomLevel = 1;
let isDragging = false;
let startX = 0, startY = 0;
let translateX = 0, translateY = 0;

const mainImage = document.getElementById('mainImage');
const imageContainer = mainImage.parentElement;

function updateImageTransform() {
    mainImage.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
}

// Click to zoom
mainImage.addEventListener('click', function(e) {
    if (!isDragging) {
        if (zoomLevel === 1) {
            zoomLevel = 2;
            mainImage.style.cursor = 'grab';
            imageContainer.style.overflow = 'hidden';
        } else {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            mainImage.style.cursor = 'zoom-in';
            imageContainer.style.overflow = 'hidden';
        }
        mainImage.style.transition = 'transform 0.3s ease';
        updateImageTransform();
        setTimeout(() => {
            mainImage.style.transition = '';
        }, 300);
    }
});

// Mouse wheel zoom
mainImage.addEventListener('wheel', function(e) {
    e.preventDefault();
    const rect = mainImage.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const oldZoom = zoomLevel;
    zoomLevel += e.deltaY > 0 ? -0.2 : 0.2;
    zoomLevel = Math.max(0.5, Math.min(4, zoomLevel)); // Limit zoom between 0.5x and 4x
    
    if (zoomLevel === 1) {
        translateX = 0;
        translateY = 0;
        mainImage.style.cursor = 'zoom-in';
    } else {
        mainImage.style.cursor = 'grab';
    }
    
    updateImageTransform();
});

// Drag functionality when zoomed
mainImage.addEventListener('mousedown', function(e) {
    if (zoomLevel > 1) {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        mainImage.style.cursor = 'grabbing';
        e.preventDefault();
    }
});

document.addEventListener('mousemove', function(e) {
    if (isDragging && zoomLevel > 1) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        updateImageTransform();
    }
});

document.addEventListener('mouseup', function() {
    if (isDragging) {
        isDragging = false;
        mainImage.style.cursor = zoomLevel > 1 ? 'grab' : 'zoom-in';
    }
});

// Double click to reset
mainImage.addEventListener('dblclick', function() {
    zoomLevel = 1;
    translateX = 0;
    translateY = 0;
    mainImage.style.cursor = 'zoom-in';
    mainImage.style.transition = 'transform 0.3s ease';
    updateImageTransform();
    setTimeout(() => {
        mainImage.style.transition = '';
    }, 300);
});

// Touch support for mobile
let lastTouchDistance = 0;
let lastTouchTime = 0;

mainImage.addEventListener('touchstart', function(e) {
    if (e.touches.length === 2) {
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        lastTouchDistance = Math.sqrt(
            Math.pow(touch2.clientX - touch1.clientX, 2) + 
            Math.pow(touch2.clientY - touch1.clientY, 2)
        );
    } else if (e.touches.length === 1) {
        const now = Date.now();
        if (now - lastTouchTime < 300) {
            // Double tap
            if (zoomLevel === 1) {
                zoomLevel = 2;
            } else {
                zoomLevel = 1;
                translateX = 0;
                translateY = 0;
            }
            mainImage.style.transition = 'transform 0.3s ease';
            updateImageTransform();
            setTimeout(() => {
                mainImage.style.transition = '';
            }, 300);
        }
        lastTouchTime = now;
    }
});

mainImage.addEventListener('touchmove', function(e) {
    if (e.touches.length === 2) {
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.sqrt(
            Math.pow(touch2.clientX - touch1.clientX, 2) + 
            Math.pow(touch2.clientY - touch1.clientY, 2)
        );
        
        if (lastTouchDistance > 0) {
            const scale = currentDistance / lastTouchDistance;
            zoomLevel *= scale;
            zoomLevel = Math.max(0.5, Math.min(4, zoomLevel));
            updateImageTransform();
        }
        lastTouchDistance = currentDistance;
    }
});

// Initialize cursor
mainImage.style.cursor = 'zoom-in';

// Preload next/previous images for better UX
{% if next_photo %}
const nextImg = new Image();
nextImg.src = '{{ next_photo.thumbnail }}';
{% endif %}
{% if prev_photo %}
const prevImg = new Image();
prevImg.src = '{{ prev_photo.thumbnail }}';
{% endif %}
</script>
{% endblock %}